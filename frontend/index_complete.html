<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌍 World Trends Explorer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌍</text></svg>">
    
    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Additional styles for improved layout -->
    <style>
        /* Global Trending Section - Remove country selector */
        .trending-controls {
            display: none !important;
        }
        
        /* Improved map container */
        .world-map-container-main {
            min-height: 500px;
            height: 60vh;
            max-height: 700px;
        }
        
        /* Selected country info */
        .selected-country-info {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 15;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .selected-country-info.visible {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .world-map-container-main {
                min-height: 400px;
                height: 50vh;
            }
            
            .selected-country-info {
                top: 10px;
                right: 10px;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .world-map-container-main {
                min-height: 350px;
                height: 45vh;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1 class="title">
                <span class="icon">🌍</span>
                World Trends Explorer
            </h1>
            <p class="subtitle">실시간 Google 트렌드 탐색기 - 국가를 클릭하여 인기 검색어를 확인하세요</p>
        </div>
    </header>

    <!-- Main container -->
    <main class="main">
        <div class="container">
            <!-- Search Section -->
            <section class="search-section">
                <h2>🔍 트렌드 검색</h2>
                <div class="input-group">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="키워드를 입력하세요 (예: 인공지능, 올림픽, 기후변화...)"
                        autocomplete="off"
                    >
                    <select id="countrySelect">
                        <option value="">🌍 전 세계</option>
                        <option value="KR">🇰🇷 한국</option>
                        <option value="US">🇺🇸 미국</option>
                        <option value="JP">🇯🇵 일본</option>
                        <option value="CN">🇨🇳 중국</option>
                        <option value="GB">🇬🇧 영국</option>
                        <option value="DE">🇩🇪 독일</option>
                        <option value="FR">🇫🇷 프랑스</option>
                        <option value="CA">🇨🇦 캐나다</option>
                        <option value="AU">🇦🇺 호주</option>
                        <option value="IN">🇮🇳 인도</option>
                        <option value="BR">🇧🇷 브라질</option>
                    </select>
                    <button id="searchBtn" type="button">
                        <span class="search-icon">🔍</span>
                        검색
                    </button>
                </div>
            </section>

            <!-- Interactive World Map Section (Main Feature) -->
            <section class="world-map-section">
                <div class="map-header">
                    <h2>🗺️ 인터랙티브 세계 지도</h2>
                    <p>국가를 클릭하면 해당 국가의 인기 검색어와 트렌드를 확인할 수 있습니다</p>
                </div>
                
                <div class="world-map-container-main">
                    <svg id="worldMap"></svg>
                    
                    <!-- Map tooltip -->
                    <div id="mapTooltip" class="map-tooltip"></div>
                    
                    <!-- Selected country info -->
                    <div id="selectedCountryInfo" class="selected-country-info">
                        <strong id="selectedCountryName">선택된 국가</strong>
                    </div>
                    
                    <!-- Map controls -->
                    <div class="map-controls">
                        <button id="resetMapBtn" class="map-control-btn">
                            🔄 지도 초기화
                        </button>
                        <button id="zoomInBtn" class="map-control-btn">
                            🔍 확대
                        </button>
                        <button id="zoomOutBtn" class="map-control-btn">
                            🔍 축소
                        </button>
                    </div>
                    
                    <!-- Map legend -->
                    <div class="map-legend">
                        <div class="legend-title">국가 클릭으로 탐색</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #667eea;"></div>
                            <span>데이터 사용 가능</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e1e5e9;"></div>
                            <span>데이터 없음</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Search Results Section (Initially Hidden) -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="results-header">
                    <h2 id="resultsTitle">"<span id="searchKeyword"></span>" 검색 결과</h2>
                    <div class="stats" id="searchStats"></div>
                </div>

                <!-- Charts Layout -->
                <div class="charts-layout">
                    <!-- Time series chart -->
                    <div class="chart-container">
                        <h3>📈 시간별 관심도 변화</h3>
                        <canvas id="trendsChart"></canvas>
                    </div>

                    <!-- Regional data -->
                    <div class="regional-data">
                        <h3>📊 지역별 관심도 TOP 15</h3>
                        <div class="regional-table" id="regionalTable">
                            <!-- Regional data will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Related queries -->
                <div class="related-section">
                    <h3>🔗 관련 검색어</h3>
                    <div class="related-grid">
                        <div class="related-column">
                            <h4>🔥 인기 검색어</h4>
                            <ul id="topQueries" class="queries-list">
                                <!-- Top queries will be populated here -->
                            </ul>
                        </div>
                        <div class="related-column">
                            <h4>📈 급상승 검색어</h4>
                            <ul id="risingQueries" class="queries-list">
                                <!-- Rising queries will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Global Trending Section - NO Country Selector -->
            <section class="global-trending-section">
                <h3>
                    <span class="trending-icon">🌍</span>
                    <span id="trendingCountryName">한국</span> 실시간 인기 검색어
                </h3>
                
                <!-- Remove trending controls completely -->
                
                <div class="trending-grid" id="globalTrendingGrid">
                    <!-- Global trending searches will be populated here -->
                </div>
            </section>

            <!-- Loading indicator -->
            <div class="loading" id="loadingIndicator" style="display: none;">
                <div class="spinner"></div>
                <p>트렌드 데이터를 불러오는 중...</p>
            </div>

            <!-- Error message -->
            <div class="error-message" id="errorMessage" style="display: none;">
                <span class="error-icon">⚠️</span>
                <span id="errorText"></span>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 World Trends Explorer | 실시간 트렌드 탐색기 | Mock Server 포트 5555 실행 중</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/api.js"></script>
    <script src="js/worldmap.js"></script>
    <script src="js/chart.js"></script>
    <script>
        // Enhanced app.js functionality for country selection
        class WorldTrendsApp {
            constructor() {
                this.api = window.trendsAPI;
                this.chart = null;
                this.worldMap = null;
                this.currentData = null;
                this.selectedCountry = { code: 'KR', name: '한국' }; // Default to Korea
                this.isLoading = false;
                
                // Country mapping
                this.countryNames = {
                    'KR': '한국',
                    'US': '미국',
                    'JP': '일본',
                    'CN': '중국',
                    'GB': '영국',
                    'DE': '독일',
                    'FR': '프랑스',
                    'CA': '캐나다',
                    'AU': '호주',
                    'IN': '인도',
                    'BR': '브라질',
                    'IT': '이탈리아',
                    'ES': '스페인',
                    'RU': '러시아',
                    'MX': '멕시코'
                };
                
                this.countryFlags = {
                    'US': '🇺🇸', 'GB': '🇬🇧', 'DE': '🇩🇪', 'FR': '🇫🇷',
                    'IT': '🇮🇹', 'ES': '🇪🇸', 'CA': '🇨🇦', 'AU': '🇦🇺',
                    'JP': '🇯🇵', 'KR': '🇰🇷', 'IN': '🇮🇳', 'BR': '🇧🇷',
                    'MX': '🇲🇽', 'RU': '🇷🇺', 'CN': '🇨🇳'
                };
                
                this.init();
            }

            async init() {
                console.log('🌍 Initializing World Trends Explorer...');
                
                try {
                    this.chart = new TrendsChart('trendsChart');
                    this.worldMap = new WorldMap('worldMap');
                    
                    this.setupEventListeners();
                    
                    // Load initial trending data for Korea
                    await this.loadTrendingSearches('KR');
                    
                    console.log('✅ World Trends Explorer initialized successfully');
                } catch (error) {
                    console.error('❌ Failed to initialize app:', error);
                    this.showError('애플리케이션 초기화에 실패했습니다');
                }
            }

            setupEventListeners() {
                // Search functionality
                const searchBtn = document.getElementById('searchBtn');
                const searchInput = document.getElementById('searchInput');
                
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => this.handleSearch());
                }
                
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleSearch();
                    });
                }
                
                // Country selection from map - THIS IS THE KEY EVENT LISTENER
                document.addEventListener('countrySelected', (e) => {
                    console.log('🗺️ Country selection event received:', e.detail);
                    this.handleCountrySelection(e.detail);
                });
                
                // Window resize
                window.addEventListener('resize', this.debounce(() => {
                    if (this.chart) this.chart.resize();
                    if (this.worldMap) this.worldMap.resize();
                }, 250));
            }

            handleCountrySelection(countryDetail) {
                console.log('🌍 Country selected:', countryDetail);
                
                // Update selected country
                this.selectedCountry = {
                    code: countryDetail.code,
                    name: countryDetail.name
                };
                
                // Show selected country info
                this.showSelectedCountryInfo(countryDetail);
                
                // Update country selector if available
                const countrySelect = document.getElementById('countrySelect');
                if (countryDetail.code && countrySelect) {
                    const option = Array.from(countrySelect.options)
                        .find(opt => opt.value === countryDetail.code);
                    if (option) {
                        countrySelect.value = countryDetail.code;
                    }
                }
                
                // ✨ MOST IMPORTANT: Load trending for selected country
                console.log('🔥 Loading trending data for country:', countryDetail.code);
                this.loadTrendingSearches(countryDetail.code || 'KR');
            }

            showSelectedCountryInfo(countryDetail) {
                const infoEl = document.getElementById('selectedCountryInfo');
                const nameEl = document.getElementById('selectedCountryName');
                
                if (infoEl && nameEl) {
                    const flag = this.countryFlags[countryDetail.code] || '🌍';
                    nameEl.textContent = `${flag} ${countryDetail.name}`;
                    infoEl.classList.add('visible');
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        infoEl.classList.remove('visible');
                    }, 3000);
                }
            }

            async loadTrendingSearches(geo = 'KR') {
                try {
                    console.log(`🔥 Loading trending searches for: ${geo}`);
                    
                    const data = await this.api.getTrendingSearches(geo);
                    console.log('📊 Received trending data:', data);
                    this.displayTrendingSearches(data, geo);
                    
                } catch (error) {
                    console.error('Failed to load trending searches:', error);
                    this.displayTrendingError();
                }
            }

            displayTrendingSearches(data, geo) {
                const grid = document.getElementById('globalTrendingGrid');
                const countryNameEl = document.getElementById('trendingCountryName');
                
                if (!grid) {
                    console.error('Could not find globalTrendingGrid element');
                    return;
                }

                // Update country name in heading
                if (countryNameEl) {
                    const countryName = this.countryNames[geo] || '전 세계';
                    console.log(`🏷️ Updating country name to: ${countryName}`);
                    countryNameEl.textContent = countryName;
                }

                grid.innerHTML = '';

                if (!data || !data.trending_searches || !Array.isArray(data.trending_searches)) {
                    console.warn('No trending data available');
                    this.displayTrendingError();
                    return;
                }

                console.log(`📈 Displaying ${data.trending_searches.length} trending items`);

                data.trending_searches.slice(0, 12).forEach(item => {
                    const element = document.createElement('div');
                    element.className = 'trending-item';
                    element.innerHTML = `
                        <div class="trending-rank">#${item.rank}</div>
                        <div class="trending-query">${this.truncateText(item.query, 30)}</div>
                    `;
                    
                    element.addEventListener('click', () => {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            searchInput.value = item.query;
                            this.handleSearch();
                        }
                    });
                    
                    grid.appendChild(element);
                });
            }

            displayTrendingError() {
                const grid = document.getElementById('globalTrendingGrid');
                if (!grid) return;
                
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">📊</div>
                        <div>인기 검색어를 불러올 수 없습니다</div>
                        <button onclick="app.loadTrendingSearches('${this.selectedCountry?.code || 'KR'}')" 
                                style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            다시 시도
                        </button>
                    </div>
                `;
            }

            async handleSearch() {
                const searchInput = document.getElementById('searchInput');
                const countrySelect = document.getElementById('countrySelect');
                
                if (!searchInput) return;
                
                const keyword = searchInput.value.trim();
                const geo = countrySelect ? countrySelect.value : '';
                
                if (!keyword) {
                    this.showError('키워드를 입력해주세요');
                    return;
                }
                
                try {
                    this.setLoading(true);
                    this.hideError();
                    
                    const data = await this.api.searchTrends(keyword, geo);
                    this.displaySearchResults(data);
                    
                } catch (error) {
                    this.showError(error.message || '트렌드 검색에 실패했습니다');
                } finally {
                    this.setLoading(false);
                }
            }

            displaySearchResults(data) {
                const resultsSection = document.getElementById('resultsSection');
                const searchKeyword = document.getElementById('searchKeyword');
                const searchStats = document.getElementById('searchStats');
                
                if (searchKeyword) searchKeyword.textContent = data.keyword;
                if (searchStats) searchStats.textContent = 
                    `업데이트: ${new Date().toLocaleString()} | 지역: ${data.geo || '전 세계'}`;
                
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            setLoading(loading) {
                this.isLoading = loading;
                const loadingEl = document.getElementById('loadingIndicator');
                const searchBtn = document.getElementById('searchBtn');
                
                if (loading) {
                    if (loadingEl) loadingEl.style.display = 'block';
                    if (searchBtn) {
                        searchBtn.disabled = true;
                        searchBtn.innerHTML = `
                            <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5rem;"></div>
                            검색 중...
                        `;
                    }
                } else {
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (searchBtn) {
                        searchBtn.disabled = false;
                        searchBtn.innerHTML = '<span class="search-icon">🔍</span>검색';
                    }
                }
            }

            showError(message) {
                const errorEl = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                
                if (errorText) errorText.textContent = message;
                if (errorEl) errorEl.style.display = 'flex';
                
                setTimeout(() => this.hideError(), 5000);
            }

            hideError() {
                const errorEl = document.getElementById('errorMessage');
                if (errorEl) errorEl.style.display = 'none';
            }

            truncateText(text, maxLength = 30) {
                if (!text || text.length <= maxLength) return text;
                return text.substring(0, maxLength - 3) + '...';
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM loaded, initializing app...');
            window.app = new WorldTrendsApp();
        });
    </script>
</body>
</html>