<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ World Trends Explorer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ</text></svg>">
    
    <!-- External libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Additional styles for improved layout -->
    <style>
        /* Global Trending Section - Remove country selector */
        .trending-controls {
            display: none !important;
        }
        
        /* Improved map container */
        .world-map-container-main {
            min-height: 500px;
            height: 60vh;
            max-height: 700px;
        }
        
        /* Selected country info */
        .selected-country-info {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 15;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .selected-country-info.visible {
            display: block;
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .world-map-container-main {
                min-height: 400px;
                height: 50vh;
            }
            
            .selected-country-info {
                top: 10px;
                right: 10px;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
        
        @media (max-width: 480px) {
            .world-map-container-main {
                min-height: 350px;
                height: 45vh;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1 class="title">
                <span class="icon">ğŸŒ</span>
                World Trends Explorer
            </h1>
            <p class="subtitle">ì‹¤ì‹œê°„ Google íŠ¸ë Œë“œ íƒìƒ‰ê¸° - êµ­ê°€ë¥¼ í´ë¦­í•˜ì—¬ ì¸ê¸° ê²€ìƒ‰ì–´ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        </div>
    </header>

    <!-- Main container -->
    <main class="main">
        <div class="container">
            <!-- Search Section -->
            <section class="search-section">
                <h2>ğŸ” íŠ¸ë Œë“œ ê²€ìƒ‰</h2>
                <div class="input-group">
                    <input 
                        type="text" 
                        id="searchInput" 
                        placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¸ê³µì§€ëŠ¥, ì˜¬ë¦¼í”½, ê¸°í›„ë³€í™”...)"
                        autocomplete="off"
                    >
                    <select id="countrySelect">
                        <option value="">ğŸŒ ì „ ì„¸ê³„</option>
                        <option value="KR">ğŸ‡°ğŸ‡· í•œêµ­</option>
                        <option value="US">ğŸ‡ºğŸ‡¸ ë¯¸êµ­</option>
                        <option value="JP">ğŸ‡¯ğŸ‡µ ì¼ë³¸</option>
                        <option value="CN">ğŸ‡¨ğŸ‡³ ì¤‘êµ­</option>
                        <option value="GB">ğŸ‡¬ğŸ‡§ ì˜êµ­</option>
                        <option value="DE">ğŸ‡©ğŸ‡ª ë…ì¼</option>
                        <option value="FR">ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤</option>
                        <option value="CA">ğŸ‡¨ğŸ‡¦ ìºë‚˜ë‹¤</option>
                        <option value="AU">ğŸ‡¦ğŸ‡º í˜¸ì£¼</option>
                        <option value="IN">ğŸ‡®ğŸ‡³ ì¸ë„</option>
                        <option value="BR">ğŸ‡§ğŸ‡· ë¸Œë¼ì§ˆ</option>
                    </select>
                    <button id="searchBtn" type="button">
                        <span class="search-icon">ğŸ”</span>
                        ê²€ìƒ‰
                    </button>
                </div>
            </section>

            <!-- Interactive World Map Section (Main Feature) -->
            <section class="world-map-section">
                <div class="map-header">
                    <h2>ğŸ—ºï¸ ì¸í„°ë™í‹°ë¸Œ ì„¸ê³„ ì§€ë„</h2>
                    <p>êµ­ê°€ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ êµ­ê°€ì˜ ì¸ê¸° ê²€ìƒ‰ì–´ì™€ íŠ¸ë Œë“œë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
                
                <div class="world-map-container-main">
                    <svg id="worldMap"></svg>
                    
                    <!-- Map tooltip -->
                    <div id="mapTooltip" class="map-tooltip"></div>
                    
                    <!-- Selected country info -->
                    <div id="selectedCountryInfo" class="selected-country-info">
                        <strong id="selectedCountryName">ì„ íƒëœ êµ­ê°€</strong>
                    </div>
                    
                    <!-- Map controls -->
                    <div class="map-controls">
                        <button id="resetMapBtn" class="map-control-btn">
                            ğŸ”„ ì§€ë„ ì´ˆê¸°í™”
                        </button>
                        <button id="zoomInBtn" class="map-control-btn">
                            ğŸ” í™•ëŒ€
                        </button>
                        <button id="zoomOutBtn" class="map-control-btn">
                            ğŸ” ì¶•ì†Œ
                        </button>
                    </div>
                    
                    <!-- Map legend -->
                    <div class="map-legend">
                        <div class="legend-title">êµ­ê°€ í´ë¦­ìœ¼ë¡œ íƒìƒ‰</div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #667eea;"></div>
                            <span>ë°ì´í„° ì‚¬ìš© ê°€ëŠ¥</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #e1e5e9;"></div>
                            <span>ë°ì´í„° ì—†ìŒ</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Search Results Section (Initially Hidden) -->
            <section class="results-section" id="resultsSection" style="display: none;">
                <div class="results-header">
                    <h2 id="resultsTitle">"<span id="searchKeyword"></span>" ê²€ìƒ‰ ê²°ê³¼</h2>
                    <div class="stats" id="searchStats"></div>
                </div>

                <!-- Charts Layout -->
                <div class="charts-layout">
                    <!-- Time series chart -->
                    <div class="chart-container">
                        <h3>ğŸ“ˆ ì‹œê°„ë³„ ê´€ì‹¬ë„ ë³€í™”</h3>
                        <canvas id="trendsChart"></canvas>
                    </div>

                    <!-- Regional data -->
                    <div class="regional-data">
                        <h3>ğŸ“Š ì§€ì—­ë³„ ê´€ì‹¬ë„ TOP 15</h3>
                        <div class="regional-table" id="regionalTable">
                            <!-- Regional data will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Related queries -->
                <div class="related-section">
                    <h3>ğŸ”— ê´€ë ¨ ê²€ìƒ‰ì–´</h3>
                    <div class="related-grid">
                        <div class="related-column">
                            <h4>ğŸ”¥ ì¸ê¸° ê²€ìƒ‰ì–´</h4>
                            <ul id="topQueries" class="queries-list">
                                <!-- Top queries will be populated here -->
                            </ul>
                        </div>
                        <div class="related-column">
                            <h4>ğŸ“ˆ ê¸‰ìƒìŠ¹ ê²€ìƒ‰ì–´</h4>
                            <ul id="risingQueries" class="queries-list">
                                <!-- Rising queries will be populated here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Global Trending Section - NO Country Selector -->
            <section class="global-trending-section">
                <h3>
                    <span class="trending-icon">ğŸŒ</span>
                    <span id="trendingCountryName">í•œêµ­</span> ì‹¤ì‹œê°„ ì¸ê¸° ê²€ìƒ‰ì–´
                </h3>
                
                <!-- Remove trending controls completely -->
                
                <div class="trending-grid" id="globalTrendingGrid">
                    <!-- Global trending searches will be populated here -->
                </div>
            </section>

            <!-- Loading indicator -->
            <div class="loading" id="loadingIndicator" style="display: none;">
                <div class="spinner"></div>
                <p>íŠ¸ë Œë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>

            <!-- Error message -->
            <div class="error-message" id="errorMessage" style="display: none;">
                <span class="error-icon">âš ï¸</span>
                <span id="errorText"></span>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 World Trends Explorer | ì‹¤ì‹œê°„ íŠ¸ë Œë“œ íƒìƒ‰ê¸° | Mock Server í¬íŠ¸ 5555 ì‹¤í–‰ ì¤‘</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="js/api.js"></script>
    <script src="js/worldmap.js"></script>
    <script src="js/chart.js"></script>
    <script>
        // Enhanced app.js functionality for country selection
        class WorldTrendsApp {
            constructor() {
                this.api = window.trendsAPI;
                this.chart = null;
                this.worldMap = null;
                this.currentData = null;
                this.selectedCountry = { code: 'KR', name: 'í•œêµ­' }; // Default to Korea
                this.isLoading = false;
                
                // Country mapping
                this.countryNames = {
                    'KR': 'í•œêµ­',
                    'US': 'ë¯¸êµ­',
                    'JP': 'ì¼ë³¸',
                    'CN': 'ì¤‘êµ­',
                    'GB': 'ì˜êµ­',
                    'DE': 'ë…ì¼',
                    'FR': 'í”„ë‘ìŠ¤',
                    'CA': 'ìºë‚˜ë‹¤',
                    'AU': 'í˜¸ì£¼',
                    'IN': 'ì¸ë„',
                    'BR': 'ë¸Œë¼ì§ˆ',
                    'IT': 'ì´íƒˆë¦¬ì•„',
                    'ES': 'ìŠ¤í˜ì¸',
                    'RU': 'ëŸ¬ì‹œì•„',
                    'MX': 'ë©•ì‹œì½”'
                };
                
                this.countryFlags = {
                    'US': 'ğŸ‡ºğŸ‡¸', 'GB': 'ğŸ‡¬ğŸ‡§', 'DE': 'ğŸ‡©ğŸ‡ª', 'FR': 'ğŸ‡«ğŸ‡·',
                    'IT': 'ğŸ‡®ğŸ‡¹', 'ES': 'ğŸ‡ªğŸ‡¸', 'CA': 'ğŸ‡¨ğŸ‡¦', 'AU': 'ğŸ‡¦ğŸ‡º',
                    'JP': 'ğŸ‡¯ğŸ‡µ', 'KR': 'ğŸ‡°ğŸ‡·', 'IN': 'ğŸ‡®ğŸ‡³', 'BR': 'ğŸ‡§ğŸ‡·',
                    'MX': 'ğŸ‡²ğŸ‡½', 'RU': 'ğŸ‡·ğŸ‡º', 'CN': 'ğŸ‡¨ğŸ‡³'
                };
                
                this.init();
            }

            async init() {
                console.log('ğŸŒ Initializing World Trends Explorer...');
                
                try {
                    this.chart = new TrendsChart('trendsChart');
                    this.worldMap = new WorldMap('worldMap');
                    
                    this.setupEventListeners();
                    
                    // Load initial trending data for Korea
                    await this.loadTrendingSearches('KR');
                    
                    console.log('âœ… World Trends Explorer initialized successfully');
                } catch (error) {
                    console.error('âŒ Failed to initialize app:', error);
                    this.showError('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            }

            setupEventListeners() {
                // Search functionality
                const searchBtn = document.getElementById('searchBtn');
                const searchInput = document.getElementById('searchInput');
                
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => this.handleSearch());
                }
                
                if (searchInput) {
                    searchInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') this.handleSearch();
                    });
                }
                
                // Country selection from map - THIS IS THE KEY EVENT LISTENER
                document.addEventListener('countrySelected', (e) => {
                    console.log('ğŸ—ºï¸ Country selection event received:', e.detail);
                    this.handleCountrySelection(e.detail);
                });
                
                // Window resize
                window.addEventListener('resize', this.debounce(() => {
                    if (this.chart) this.chart.resize();
                    if (this.worldMap) this.worldMap.resize();
                }, 250));
            }

            handleCountrySelection(countryDetail) {
                console.log('ğŸŒ Country selected:', countryDetail);
                
                // Update selected country
                this.selectedCountry = {
                    code: countryDetail.code,
                    name: countryDetail.name
                };
                
                // Show selected country info
                this.showSelectedCountryInfo(countryDetail);
                
                // Update country selector if available
                const countrySelect = document.getElementById('countrySelect');
                if (countryDetail.code && countrySelect) {
                    const option = Array.from(countrySelect.options)
                        .find(opt => opt.value === countryDetail.code);
                    if (option) {
                        countrySelect.value = countryDetail.code;
                    }
                }
                
                // âœ¨ MOST IMPORTANT: Load trending for selected country
                console.log('ğŸ”¥ Loading trending data for country:', countryDetail.code);
                this.loadTrendingSearches(countryDetail.code || 'KR');
            }

            showSelectedCountryInfo(countryDetail) {
                const infoEl = document.getElementById('selectedCountryInfo');
                const nameEl = document.getElementById('selectedCountryName');
                
                if (infoEl && nameEl) {
                    const flag = this.countryFlags[countryDetail.code] || 'ğŸŒ';
                    nameEl.textContent = `${flag} ${countryDetail.name}`;
                    infoEl.classList.add('visible');
                    
                    // Hide after 3 seconds
                    setTimeout(() => {
                        infoEl.classList.remove('visible');
                    }, 3000);
                }
            }

            async loadTrendingSearches(geo = 'KR') {
                try {
                    console.log(`ğŸ”¥ Loading trending searches for: ${geo}`);
                    
                    const data = await this.api.getTrendingSearches(geo);
                    console.log('ğŸ“Š Received trending data:', data);
                    this.displayTrendingSearches(data, geo);
                    
                } catch (error) {
                    console.error('Failed to load trending searches:', error);
                    this.displayTrendingError();
                }
            }

            displayTrendingSearches(data, geo) {
                const grid = document.getElementById('globalTrendingGrid');
                const countryNameEl = document.getElementById('trendingCountryName');
                
                if (!grid) {
                    console.error('Could not find globalTrendingGrid element');
                    return;
                }

                // Update country name in heading
                if (countryNameEl) {
                    const countryName = this.countryNames[geo] || 'ì „ ì„¸ê³„';
                    console.log(`ğŸ·ï¸ Updating country name to: ${countryName}`);
                    countryNameEl.textContent = countryName;
                }

                grid.innerHTML = '';

                if (!data || !data.trending_searches || !Array.isArray(data.trending_searches)) {
                    console.warn('No trending data available');
                    this.displayTrendingError();
                    return;
                }

                console.log(`ğŸ“ˆ Displaying ${data.trending_searches.length} trending items`);

                data.trending_searches.slice(0, 12).forEach(item => {
                    const element = document.createElement('div');
                    element.className = 'trending-item';
                    element.innerHTML = `
                        <div class="trending-rank">#${item.rank}</div>
                        <div class="trending-query">${this.truncateText(item.query, 30)}</div>
                    `;
                    
                    element.addEventListener('click', () => {
                        const searchInput = document.getElementById('searchInput');
                        if (searchInput) {
                            searchInput.value = item.query;
                            this.handleSearch();
                        }
                    });
                    
                    grid.appendChild(element);
                });
            }

            displayTrendingError() {
                const grid = document.getElementById('globalTrendingGrid');
                if (!grid) return;
                
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ“Š</div>
                        <div>ì¸ê¸° ê²€ìƒ‰ì–´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <button onclick="app.loadTrendingSearches('${this.selectedCountry?.code || 'KR'}')" 
                                style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                `;
            }

            async handleSearch() {
                const searchInput = document.getElementById('searchInput');
                const countrySelect = document.getElementById('countrySelect');
                
                if (!searchInput) return;
                
                const keyword = searchInput.value.trim();
                const geo = countrySelect ? countrySelect.value : '';
                
                if (!keyword) {
                    this.showError('í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                    return;
                }
                
                try {
                    this.setLoading(true);
                    this.hideError();
                    
                    const data = await this.api.searchTrends(keyword, geo);
                    this.displaySearchResults(data);
                    
                } catch (error) {
                    this.showError(error.message || 'íŠ¸ë Œë“œ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                } finally {
                    this.setLoading(false);
                }
            }

            displaySearchResults(data) {
                const resultsSection = document.getElementById('resultsSection');
                const searchKeyword = document.getElementById('searchKeyword');
                const searchStats = document.getElementById('searchStats');
                
                if (searchKeyword) searchKeyword.textContent = data.keyword;
                if (searchStats) searchStats.textContent = 
                    `ì—…ë°ì´íŠ¸: ${new Date().toLocaleString()} | ì§€ì—­: ${data.geo || 'ì „ ì„¸ê³„'}`;
                
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            setLoading(loading) {
                this.isLoading = loading;
                const loadingEl = document.getElementById('loadingIndicator');
                const searchBtn = document.getElementById('searchBtn');
                
                if (loading) {
                    if (loadingEl) loadingEl.style.display = 'block';
                    if (searchBtn) {
                        searchBtn.disabled = true;
                        searchBtn.innerHTML = `
                            <div style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 0.5rem;"></div>
                            ê²€ìƒ‰ ì¤‘...
                        `;
                    }
                } else {
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (searchBtn) {
                        searchBtn.disabled = false;
                        searchBtn.innerHTML = '<span class="search-icon">ğŸ”</span>ê²€ìƒ‰';
                    }
                }
            }

            showError(message) {
                const errorEl = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorText');
                
                if (errorText) errorText.textContent = message;
                if (errorEl) errorEl.style.display = 'flex';
                
                setTimeout(() => this.hideError(), 5000);
            }

            hideError() {
                const errorEl = document.getElementById('errorMessage');
                if (errorEl) errorEl.style.display = 'none';
            }

            truncateText(text, maxLength = 30) {
                if (!text || text.length <= maxLength) return text;
                return text.substring(0, maxLength - 3) + '...';
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ DOM loaded, initializing app...');
            window.app = new WorldTrendsApp();
        });
    </script>
</body>
</html>